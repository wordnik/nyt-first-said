import unittest
from utils.headless import HeadlessBrowser
from parsers.parse_fns import nyt_browser, parse_nyt_data
import json
import os

class HeadlessSuite(unittest.TestCase):
  def test_basic(self):
      browser = HeadlessBrowser()
      page = browser.get_page("https://wordnik.com/")
      button_element = page.locator("input[name='commit']")
      self.assertTrue(button_element, "Search button is found on the page.")
      print(button_element.get_attribute("value"))
      self.assertEqual(button_element.get_attribute("value"), "I always feel lucky", "We found the button with the correct value.")
      browser.close()
      with self.assertRaisesRegex(ChildProcessError, 'Browser not initialized'):
          browser.get_page("https://google.com")

  def test_nyt(self):
      browser = HeadlessBrowser()
      page = browser.get_page("https://www.nytimes.com/2025/11/22/climate/cop30-climate-summit-ends-belem.html")
      res = nyt_browser(page)
      # TODO: Make test that can survive content updates.
      self.assertEqual(res["body"], "Global climate negotiations ended on Saturday in Brazil with a watered-down resolution that made no direct mention of fossil fuels, the main driver of global warming. The final statement, roundly criticized by diplomats as insufficient, was a victory for oil producers like Saudi Arabia and Russia. It included plenty of warnings about the cost of inaction but few provisions for how the world might address dangerously rising global temperatures head-on. Without a rapid transition away from oil, gas and coal, scientists warn, the planet faces increasing devastation from deadly heat waves, droughts, floods and wildfires. A marathon series of frenetic Friday night meetings ultimately salvaged the talks in Belém, on the edge of the Amazon rainforest, from total collapse. Oil-producing countries like Saudi Arabia were adamant that their key export not be singled out. They were joined by many African and Asian countries that argued, as they have in earlier talks, that Western countries bear unique responsibility in paying for climate change because they are historically responsible for the most greenhouse gas emissions. Around 80 countries, or a little under half of those present, demanded a concrete plan to move away from fossil fuels. Outside of Europe, they did not include any of the world’s major economies. After the gavel fell, André Corrêa do Lago, the Brazilian diplomat leading the talks, announced that his country would lead an independent effort to rally nations to develop specific plans for transitioning away from fossil fuels and for protecting tropical forests. The political effort would have no force of international law, but there was a round of polite applause from delegates. Then the objections began. Panama, then Colombia, then the European Union. One after another, diplomats said they were bitterly disappointed in the process and the outcome. “Mr. President, this is the COP of truth,” said Daniela Durán González, a Colombian diplomat. “The truth cannot support an outcome that ignores the science.” She and others said that the summit leaders had ignored their concerns before approving the deal. Activists said the weak deal heightened fears among many countries, particularly vulnerable island states, that the world is politically unwilling or unable to address climate change and its cascade of accompanying catastrophes. “Petrostates and their political allies are doing everything they can to try to stop the world from making progress on solving the climate crisis,” former Vice President Al Gore said in a statement. “They fiercely opposed what would have been the most important step forward at COP30: the development of a road map away from fossil fuels.” The talks, known as COP30, were inauspicious from the get-go. The U.S. government under President Trump effectively boycotted the annual gathering, thumbing its nose at multilateral climate action while simultaneously revving up the American fossil fuel industry and repealing federal support for renewable energy and electric vehicles. It was the first time in 30 years of climate talks that the United States had not attended. And yet, in many ways, the disappointment of the summit was a result of America’s absence. While the United States under Democratic administrations has not always been a champion of ambitious climate action, it had consistently succeeded in one thing: Demanding that major economies with high greenhouse gas emissions, like China and Saudi Arabia, take on more responsibility. Without the United States, diplomats in Belém acknowledged, that enormous source of pressure was gone. “The U.S. has harmed itself by taking itself out of the process,” said David Waskow, who leads the climate program at the World Resources Institute, a research group. “It’s not here to push a number of other economies. For example, China.” Taylor Rogers, a White House spokeswoman, declined to comment on the outcome of the talks, but said in a statement that Mr. Trump had “set a strong example for the rest of the world” by pursuing new fossil fuel development. “President Trump has been clear,” she said. “He will not jeopardize our country’s economic and national security to pursue vague climate goals that are killing other countries.” China, currently the world’s largest greenhouse gas emitter by far,  played a limited role in Belém , choosing not to step into the leadership vacuum created by the absence of the United States. Despite dominating the world’s clean energy industry, China avoided strong positions on most, if not all, of the main sticking points at the talks: reducing emissions, providing money to help poorer countries cope with climate change and contributions to  a new Brazilian fund aimed at stemming deforestation.  At China’s urging, the deal calls for nations to not use climate as an excuse to restrict international trade. The mild resolution was also a rebuff of Brazil’s president, Luiz Inácio Lula da Silva, who had billed the event as a historic moment to make progress on climate action while showcasing the Amazon, often called the “lungs of the world” for the huge amount of planet-warming carbon dioxide it pulls out of the atmosphere. In a speech that opened the talks, he called for negotiators to deliver a “road map” for a global transition away from fossil fuels. In the end, there was no such plan. At talks two years ago in Dubai, the nations of the world already agreed on a “transition away” from fossil fuels by the middle of this century. Heeding President Lula’s suggestion, a group of countries — including Britain, Colombia, Denmark, France, Germany and Kenya — had pushed in Belém for a detailed plan. A simple acknowledgment of the Dubai deal is all they got. The final deal says countries should implement their climate plans “taking into account the decisions” made in Dubai. Europeans said the language, while coded, was still a win. “We know that it is very difficult for many countries, like oil-producing countries, that have been very vocal against it,” said Maria da Graça Carvalho, Portugal’s environment minister. “It was the best we could get to have this reference.” Negotiators from the European Union had argued particularly for inclusion of language around fossil fuels, but a wide range of developing countries maintained that it was more important for Western countries to pledge larger amounts of money to help poorer ones cope with the already-mounting costs of global warming. That responsibility, they said, should fall largely on European countries and the United States because of their giant contributions to greenhouse gas emissions since the Industrial Revolution began. The United States alone accounts for roughly a quarter of all greenhouse gas emissions to date. Ali Mohamed, Kenya’s climate envoy, said that financial obligations from rich countries to poor ones “cannot remain afterthoughts for a continent responsible for less than 4 percent of global emissions.” President Lula’s signature anti-deforestation initiative, the Tropical Forests Forever Facility, also fell far short of his ambitious goal of raising $25 billion in public financing that would essentially pay countries to protect forests. By the end of the talks, the program had received around $5 billion in pledges from a small handful of countries, including Norway, Indonesia and France, with Germany saying it would soon contribute an unspecified amount. The deal did bolster promises of funding to protect communities from the impacts of climate-fueled disasters. Small island nations in particular wanted more assurances that nations would triple adaptation finance, and the final agreement does that, calling for “efforts to at least   triple adaptation finance by 2035.” Exhausted delegates had long trips home ahead of them. Belém, while vibrant, was an incredibly expensive and hard-to-reach venue for negotiators from other continents. The city also lacked enough accommodations for the roughly 50,000 attendees, and many slept on two European cruise ships brought to Belém as temporary hotels, while others made makeshift arrangements with locals to sleep in their apartments. The purpose-built event space was only completed in the days before negotiators arrived. Near-daily torrential rains buffeted its flimsy walls, and as water poured into negotiating rooms, deafening claps of thunder raised goose bumps. On Thursday, as negotiations headed into their most intense final stretch,  a fire broke out . The venue was evacuated, 13 people were treated for smoke inhalation and negotiators resorted to diplomacy in Uber rides between one another’s hotels. In the end, the talks were stymied by the widening gulf between the world’s biggest emitters and the poorest, most vulnerable countries, which are pleading for a more ambitious collective response to climate change. “I couldn’t say we’re happy, but we are giving thanks that in this geopolitical climate that we have not regressed,” said Ruleta Camacho Thomas, who represented Antigua and Barbuda at the talks. “We had hoped that the evidence of what is actually happening on our islands would have been enough to leverage more support.” Ten years ago at landmark climate talks near Paris, nearly 200 nations agreed to keep the average increase in global temperature to “well below” 2 degrees Celsius, or 3.6 degrees Fahrenheit, and preferably closer to 1.5 degrees Celsius, compared with preindustrial levels. While significant progress has been made, the “well below” 2-degree goal is almost certain to not be met,  given a decade of sluggish action . Based on policies that countries have put in place and current technology trends, Earth is expected to warm by roughly 2.8 degrees Celsius this century, compared with preindustrial levels,  according to the latest U. N. calculations . Emissions have increased significantly since the Paris Agreement in 2015. Carbon dioxide from the burning of fossil fuels is  on track to hit a record high  this year. The world has already warmed about 1.3 degrees Celsius since late 19th-century averages. Scientists have repeatedly warned that each tenth of a degree of warming makes the climate both less predictable — with enormous ramifications for agriculture, urban planning and global supply chains — as well as more prone to extremes like droughts, floods and wildfires, which are deepening humanitarian crises and driving waves of migration.", "Content is retrieved.")
      self.assertEqual(res["meta"], {'documentTitle': 'Oil Producers, but Maybe Not the Planet, Get a Win as Climate Talks End', 'documentId': 'QXJ0aWNsZTpueXQ6Ly9hcnRpY2xlL2MzY2Q4MGMyLWIwOTAtNTBlOC05YWMwLTdmNjcwM2ViOWI3YQ==', 'description': 'The final agreement, with no direct mention of the fossil fuels dangerously heating Earth, was a victory for countries like Saudi Arabia and Russia, diplomats said.', 'subjects': ['United Nations Framework Convention on Climate Change', 'Belem (Brazil)', 'Global Warming', 'Greenhouse Gas Emissions'], 'pubDate': '2025-11-22T16:36:19.000Z', 'author': 'By Max Bearak and Lisa Friedman'})
      browser.close()

  def test_nyt_data_parse(self):
    self.maxDiff = None
    f = open("test/fixtures/nyt-data.json", "r")
    data_text = f.read()
    data = json.loads(data_text)
    parsed = parse_nyt_data(data)
    f.close()
    f = open("test/fixtures/expected-nyt-parse.json", "r")
    data_text = f.read()
    expected = json.loads(data_text)
    self.assertEqual(parsed, expected, "Data is parsed correctly.")
    f.close()


if __name__ == '__main__':
    unittest.main()
